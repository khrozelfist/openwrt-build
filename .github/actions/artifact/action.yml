name: "Deliver artifact"
runs:
  using: "composite"
  steps:
    - name: Prepare artifact
      shell: bash
      run : |
        mkdir -p ./openwrt/bin/targets

        # INFO=$(find ./openwrt/bin/targets/ -type f \( -name '*.buildinfo' -o -name '*.manifest' \))
        INFO=$(find ./openwrt/bin/targets/ -type f ! -size +16M)
        [ "$INFO" ] && cp -rf $INFO ./artifact/buildinfo/
        find ./openwrt/bin/targets/ -path "*/packages" -prune -o -printf "%p %s\n" >./artifact/buildinfo/targets.output
        find ./openwrt/bin/ -type f -regex '.*\.\(ipk\|apk\)$' >./artifact/buildinfo/packages.${{env.mode}}

        [ -s ./artifact/buildinfo/packages.${{env.mode}} ] && cp -rf $(cat ./artifact/buildinfo/packages.${{env.mode}}) ./artifact/package/
        # PKG=$(find ./openwrt/bin/ -type f -regex '.*\.\(ipk\|apk\)$')
        # PKG=$(find ./openwrt/bin/packages/ -type f -regex '.*\.\(ipk\|apk\)$')
        # [ "$PKG" ] && cp -rf $PKG ./artifact/package/
        # rm -rf $(find ./openwrt/bin/targets/ -type d -name "packages")

        # cp -rf $(find ./openwrt/bin/targets/ -type f) ./artifact/firmware/
        # rm -rf $(find ./artifact/firmware/ -type f -name "*.bin")
        # rm -rf $(find ./artifact/firmware/ -type f -name "*.tar.gz")
        # rm -rf $(find ./artifact/firmware/ -type f -name "*.img*" | grep -v "combined-efi")

    - name: Deliver buildinfo
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_buildinfo_${{env.tag}}_${{env.date}}
        path: ./artifact/buildinfo/

    - name: Deliver package
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_package_${{env.tag}}_${{env.date}}
        path: ./artifact/package/

    - name: Deliver firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_firmware_${{env.tag}}_${{env.date}}
        path: ./artifact/firmware/
